from llm.ollama_client import ask_llm
from utils.helpers import extract_json_from_text

_clean_cache = {}

number_words = {
    "1": 1, "один": 1, "первая": 1, "первый": 1, "первое": 1, "по первому": 1, "одна": 1, "первым": 1,
    "2": 2, "два": 2, "второй": 2, "вторая": 2, "второе": 2, "по второму": 2, "вторым": 2,
    "3": 3, "три": 3, "третий": 3, "третья": 3, "третье": 3, "по третьему": 3, "третьим": 3,
    "4": 4, "четыре": 4, "четвёртый": 4, "четвертый": 4, "четвёртая": 4, "четвертая": 4,
         "четвёртое": 4, "четвертое": 4, "по четвёртому": 4, "по четвертому": 4,
    "5": 5, "пять": 5, "пятый": 5, "пятая": 5, "пятое": 5, "по пятому": 5,
    "6": 6, "шесть": 6, "шестой": 6, "шестая": 6, "шестое": 6, "по шестому": 6,
    "7": 7, "семь": 7, "седьмой": 7, "седьмая": 7, "седьмое": 7, "по седьмому": 7,
    "8": 8, "восемь": 8, "восьмой": 8, "восьмая": 8, "восьмое": 8, "по восьмому": 8,
    "9": 9, "девять": 9, "девятый": 9, "девятая": 9, "девятое": 9, "по девятому": 9,
    "10": 10, "десять": 10, "десятый": 10, "десятая": 10, "десятое": 10, "по десятому": 10,
    "11": 11, "одиннадцать": 11, "одиннадцатый": 11, "одиннадцатая": 11, "одиннадцатое": 11,
    "12": 12, "двенадцать": 12, "двенадцатый": 12, "двенадцатая": 12, "двенадцатое": 12,
    "13": 13, "тринадцать": 13, "тринадцатый": 13, "тринадцатая": 13, "тринадцатое": 13,
    "14": 14, "четырнадцать": 14, "четырнадцатый": 14, "четырнадцатая": 14, "четырнадцатое": 14,
    "15": 15, "пятнадцать": 15, "пятнадцатый": 15, "пятнадцатая": 15, "пятнадцатое": 15,
    "16": 16, "шестнадцать": 16, "шестнадцатый": 16, "шестнадцатая": 16, "шестнадцатое": 16,
    "17": 17, "семнадцать": 17, "семнадцатый": 17, "семнадцатая": 17, "семнадцатое": 17,
    "18": 18, "восемнадцать": 18, "восемнадцатый": 18, "восемнадцатая": 18, "восемнадцатое": 18,
    "19": 19, "девятнадцать": 19, "девятнадцатый": 19, "девятнадцатая": 19, "девятнадцатое": 19,
    "20": 20, "двадцать": 20, "двадцатый": 20, "двадцатая": 20, "двадцатое": 20
}


EXAMPLES = """
Фраза: "Джарвис, помоги мне пожалуйста, открой мне папку с названием Game"
Ответ: "открой папку Game"

Фраза: "Джарвис, запусти браузер срочно пожалуйста"
Ответ: "запусти браузер"

Фраза: "Открой сайт ютуб плиз"
Ответ: "открой сайт ютуб"

Фраза: "Привет Джарвис, будь добр, удали папку temp"
Ответ: "удали папку temp"

Фраза: "Сделай скриншот экрана"
Ответ: "сделай скриншот экрана"
"""

def semantic_clean_via_llm(user_text: str) -> str:
    if user_text in _clean_cache:
        return _clean_cache[user_text]

    prompt = f"""
Ты лучший в мире клинер пользовательских команд. 
Твоя задача — убрать из фразы лишние слова, обращения, вежливые обороты, эмоции, смайлики. 
Верни короткую суть команды для исполнения. Отвечай строго одной строкой без лишних символов и без комментариев.

Вот примеры:
{EXAMPLES}

Фраза: "{user_text}"
Ответ:
"""

    response = ask_llm(prompt).strip().strip('"')
    _clean_cache[user_text] = response
    return response

def num_cliener(user_text: str) -> str:
    user_text = user_text.strip().lower()
    for word in user_text.split():
        if word in number_words:
            return str(number_words[word])
    if user_text in number_words:
        return str(number_words[user_text])
    return "0"

